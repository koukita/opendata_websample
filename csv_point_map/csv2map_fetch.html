<!DOCTYPE html>
<html lang="en"></html>
<body>
    <meta charset="utf-8">
    <link href="https://koukita.github.io/opendata_websample/Library/leaflet/map/leaflet.css" rel="stylesheet" /><script src="https://koukita.github.io/opendata_websample/Library/leaflet/map/leaflet.js"></script><!--CSVの文字コード変更--><script type="text/JavaScript" src="https://koukita.github.io/opendata_websample/Library/text/encoding.min.js"></script><!-- クラスタリングするプラグイン --><script src="https://koukita.github.io/opendata_websample/Library/leaflet/markercluster/src/leaflet.markercluster.js"></script>
    <link href="https://koukita.github.io/opendata_websample/Library/leaflet/markercluster/dist/MarkerCluster.css" rel="stylesheet" />
    <link href="https://koukita.github.io/opendata_websample/Library/leaflet/markercluster/dist/MarkerCluster.Default.css" rel="stylesheet" />
    <style type="text/css">/* 地図の大きさを指定 */
                #map_csv{
                    width: 100%;
                    height: 500px;
                }
                /* モバイル対応 幅が700px以下だと縦に並べる */
                @media screen and (max-width: 700px) {   /* スクリーンが700px以下ならこの設定で地図を表示 */
                    #map {
                        width: 350px;
                        height: 350px;
                        border: 1px solid #000000;
                    }
                }
    </style>
    <div><font color="darkcyan"><b>★実証・研修に活用可能なフィールド</b></font></div>
    
    <div id="data_kensu">&nbsp;</div>
    
    <p><font color="red"><b><!--確認のためにデータの件数を表示--> </b></font></p>
    
    <div id="map_csv">&nbsp;</div>
    <!--地図を表示する部分--><script>
    
            //■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■
            //地図に表示するデータはここで指定するだけ
    
            //データCSVのURL　※緯度経度の記録されたCSVファイル
            var csv01Url = "https://www.harp.lg.jp/opendata/dataset/1243/resource/4967/01_%E7%97%85%E9%99%A2_%E5%8C%97%E6%B5%B7%E9%81%93_%E7%B7%AF%E5%BA%A6%E7%B5%8C%E5%BA%A6%E4%BB%98%E3%81%8D.csv"
            //ポップアップで表示するための列名をリストで指定
            var popupList = ['名称']
            //ポップアップ表の幅
            var head_width = 100 //見出し列の幅
            var col_width = 200  //データ列の幅
    
            //マーカーにマウスを重ねたときに表示するデータの列名
            var mouseoveritem ='名称'
    
            //＝＝＝地図の設定＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝
            //緯度、経度の列名
            var lat = '緯度'
            var lon = '経度'
    
            //地図の初期表示位置（緯度経度で指定）※地理院地図（https://maps.gsi.go.jp/）からコピーできます
            var mapCenter = [43.517,142.614]
            //※参考：北海道の中心[43.517,142.614]
    
            //始めに表示するズームレベル
            var defZoomLevel = 7
    
            //ポイントのスタイル設定（円）
            var p_color = 'darkcyan'  //線の色       赤＝#FF0000　青＝#0000ff　緑＝#008000　黄色＝#ffff00　黒＝#000000　白＝#ffffff
            var p_weight = 3         //線の太さ
            var p_opacity = 0.8      //線の透過率
            var p_fillColor = 'darkcyan'   //塗りつぶし色
            var p_fillOpacity = 0.3  //塗りつぶしの透過率
            var p_radius = 8         //円の大きさ
    
            //＝＝＝クラスタリングの設定（データが多い場合はポイントをまとめる）＝＝＝＝
            //クラスタリングする？（しない：0、する：1）
            var cluster_on = 0
    
            //クラスタリング（ポイントをまとめる）距離（ピクセル）
            var clus_leng = 30
    
            //■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■
    
    
            //=======================================================
            //緯度経度のあるCSVをポイントとして地図に表示
            //=======================================================
            //CSVを読み込んで、文字コードを変換後Jsonに変換＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝
            var req01 = new XMLHttpRequest(); // HTTPでファイルを読み込むためのXMLHttpRrequestオブジェクトを生成
            req01.open("get", csv01Url, true); // アクセスするファイルを指定
            req01.responseType = 'arraybuffer'; //CSVをバイナリデータとして読み込み（重要）
            req01.send(null); // HTTPリクエストの発行
            var json01 = [];
            // 非同期CSVのレスポンスが返ってきたら地図作成処理を行う
            //文字コードを変換後にJsonに変換
            fetch(csv01Url) // (1) リクエスト送信
                .then(response => response.arrayBuffer()) // (2) レスポンスデータを取得
                .then(data => { // (3)レスポンスデータを処理
                    var csv_unicodeStr01 = csv_unicode(data) //UNICODEに変換する関数にデータを渡す
                    var new_csv = csvToArray(csv_unicodeStr01) //セル内改行があるCSVを修正して配列を作成
                    var json01 = csvToJson(new_csv) //CSVからJsonを作成
                    console.log(json01)
        
                    //==================================================
                    //Leaflet地図を表示する
                    //==================================================
        
                    //地理院地図            
                    var m_Chiriin = new L.tileLayer('https://cyberjapandata.gsi.go.jp/xyz/pale/{z}/{x}/{y}.png', {
                        attribution: "<a href='http://www.gsi.go.jp/kikakuchousei/kikakuchousei40182.html' target='_blank'>国土地理院</a>",
                        opacity: 1.0,
                        attribution: '地理院地図' });
        
                    var map = L.map('map_csv', {
                        zoomControl:true, maxZoom:18, minZoom:7,  //ズームコントロール、ズームレベル
                        center:mapCenter,                 //初期表示の中心位置
                        zoom: defZoomLevel,               //初期表示のズームレベル
                        layers: [m_Chiriin],                                  
                    });
                    
                    //著作権表示
                    map.attributionControl.setPrefix(' <a href="http://leafletjs.com" title="A JS library for interactive maps">Leaflet</a>');
                    var bounds_group = new L.featureGroup([]);
        
                    if (cluster_on == 1){
                        //===マーカーをクラスタリングする=========================
                        //【Leaflet.markercluster】（https://github.com/Leaflet/Leaflet.markercluster）
                        //参考としたサイト［https://qiita.com/mitch0807/items/52698a561d4255578657］
                        var markers = L.markerClusterGroup({maxClusterRadius:clus_leng}); //まとめる距離を1に設定 
                    };
        
                    //ポイントマーカーの表示
                    //※Jsonを1行ずつ読み込んで、位置情報とデータを取得し地図に表示
                    var dataCount = 0;
                    var errCount = 0;
                    for (i = 0; i < json01.length; i++) {
                        if (json01[i][lat] == null){
                            errCount = errCount + 1;  //緯度経度の無いデータの件数
                        }else{
                            //ポップアップのテーブルをリストから作成する
                            var popupitem = "";
                            for (j = 0; j < popupList.length; j++) {
                                if (json01[i][popupList[j]]==null) {
                                    popupitem = popupitem + '<tr><th scope="row">' + popupList[j] + 
                                        '</th><td></td></tr>'
                                }else if (json01[i][popupList[j]].match(/http/)) {
                                    popupitem = popupitem + '<tr><th scope="row">' + popupList[j] + 
                                        '</th><td>' + (json01[i][popupList[j]] !== null ? '<a href=' + String(json01[i][popupList[j]]) +' target="_blank">PDFへのリンク</a>' : '') +
                                        '</td></tr>'
                                }else{
                                    popupitem = popupitem + '<tr><th scope="row">' + popupList[j] + 
                                        '</th><td>' + (json01[i][popupList[j]] !== null ? String(json01[i][popupList[j]]) : '') +
                                        '</td></tr>'
                                };
                            };
                            //ポップアップ時に表示する吹き出し（テーブル）の設定
                            var popupContent = '<table width="' + (head_width + col_width) + '">\
                                    <col width="' + head_width + '">\
                                    <col width="' + col_width + '">' + popupitem + '</table>'; 
        
                            //地図上に表示するデータの設定
                            // var marker = L.marker([(json01[i][lat]), (json01[i][lon])],{
                            //     title:(json01[i][mouseoveritem])   //タイトル（マウスを合わせると表示される値）の設定
                            var marker = L.circleMarker([(json01[i][lat]), (json01[i][lon])],{
                                color: p_color,
                                weight: p_weight,
                                opacity: p_opacity,
                                fillColor: p_fillColor,
                                fillOpacity: p_fillOpacity,
                                radius: p_radius
                            //ポップアップの内容
                            }).bindPopup((popupContent));
                            marker.bindTooltip(json01[i][mouseoveritem]);  //ツールチップ（マウスを合わせると表示される値）の設定
                            if (cluster_on == 1){
                                markers.addLayer(marker); //クラスタリングする場合はmarkers変数にマーカーを格納
                            } else {
                                marker.addTo(map); //地図に表示
                            };
                            dataCount = dataCount + 1;  // マーカーの件数
                        }
                        if (cluster_on == 1){
                                map.addLayer(markers); //クラスタリングしたマーカー群を地図に追加
                        };
        
                    };
                    document.getElementById('data_kensu').innerHTML = "データ件数：" + dataCount + "件"  //HTMLに書き込み
                    console.log("ポイント："+ dataCount + "件")
                    console.log("エラー："+ errCount + "件")
                    //=======================================地図表示はここまで==================
                }); //CSV読み込み終了    
            
    
            //＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝
            //   CSVの文字コードをUNICODEに変換する関数
            //＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝
            var csv_unicode = function(sjisStr) {
                //UNICODEに文字コード変換したCSVを作成
                if (sjisStr){
                    var sjisArray = new Uint8Array(sjisStr)  //文字コードで配列を作成
                    var detectedEncoding = Encoding.detect(sjisArray); //文字コードを判別して、処理を分岐
                    console.log('文字コードは' + detectedEncoding);
                    switch (detectedEncoding){
                        case 'UNICODE':
                            var fromEncoding = 'SJIS';  //UNICODEの場合はSJISに変換
                            break;
                        case 'UTF8':
                            var fromEncoding = 'UTF8';
                            break;                    
                        case 'SJIS':
                            var fromEncoding = 'SJIS';
                            break;
                        default:
                            var fromEncoding = 'AUTO';                    
                    };
                    var unicodeArray = Encoding.convert(sjisArray,{ //encoding.jsでSJISをUNIDODEに変換
                        to: 'UNICODE',
                        from: fromEncoding  //文字コードの判定は自動
                    });
                    var unicodeStr = Encoding.codeToString(unicodeArray); //UNICODEのテキストデータ
                    unicodeStr = unicodeStr.replace(/\r/g, '') //Excel特有の改行コード「\r」を削除
                }
                return unicodeStr;
            }; //＝＝＝ここまで＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝
    
            //＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝
            //   セル内改行のCSVを修正する関数（参考：https://qiita.com/momosetkn/items/869aa22ab10f0ec5a529）
            //＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝
            function csvToArray(csvString) {
                var separator = '\t';
                var columnSize = csvString.split(/\r\n|\r|\n/)[0].split(separator).length;
                var chars = Array.from(csvString.replace(/\r\n|\r|\n/g, '\n'));
                var csvList = [];
                var list = [];
                var queteOpenFlg = false;
                var buf = "";
                for (var i = 0; i < chars.length; i++) {
                    if (chars[i] == '"') {
                    queteOpenFlg = queteOpenFlg == false;
                    } else {
                    if ((chars[i] == separator || chars[i] == '\n') && !queteOpenFlg) {
                        //データ一つのリストになっていたため、カンマ区切りでデータを取得するように変更
                        listData = buf.split(',');  //カンマ「,」区切りで配列に値を代入
                        buf = "";
                        csvList.push(listData); //カンマ区切りのリストをcsvの行として追加
                    } else {
                        buf += chars[i];
                    }
                    }
                }
                var csv = {};
                csv.dataList = [];
                for (var i = 0; i < csvList.length; i++) {
                    if (i == 0) {
                    csv.header = csvList[i];  //1行目をヘッダーにする
                    } else {
                    csv.dataList.push(csvList[i]);  //2行目以降はdataListに入れる
                    }
                }
                return csv;
            };
    
            //＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝
            //   CSVをJsonに変換する関数(csvtoArrayで配列に変換されている場合)
            //＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝
            function csvToJson(csv2array) {
                var rows = csv2array.dataList
                // console.log(rows)
                var json = [], line = [], row = '', data = {};
                var i, len, j, len2;
                //１行ずつデータを分割し、Json形式に変換
                for (i = 0, len = rows.length; i < len; i++) {
                    if (csv2array.header.length > 0) {  //ヘッダーの要素数が0か確認
                        data = {};
                        for (j = 0, len2 = rows[i].length; j < len2; j++) {  //各行の要素数分繰り返し
                            if (typeof rows[i][j] !== 'undefined') {  //データに型が定義されているか確認
                                rowData = rows[i][j];  //要素一つを代入
                                rowData = rowData.replace(/^"(.+)?"$/, '$1'); //不要な「”」文字を変換
                            } else {
                                //型が定義されていない場合は「NULL」を代入
                                rowData = null;
                            }
                            data[csv2array.header[j]] = rowData;  //通常はこれ
                        }
                        json.push(data);  //１行づつjsonに追加
                    } else {
                        //ヘッダーの要素が0なら、列名無しでjsonに追加
                        json.push(rows[i]);
                    }
                }
            
                return json;
            }
        </script>
</body>
</html>