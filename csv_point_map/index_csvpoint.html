<!DOCTYPE html>
<html lang="en"></html>
<body>
  <meta charset="utf-8">
  <link rel="stylesheet" href="https://koukita.github.io/opendata/hodmap/css/leaflet.css">

  <link rel="stylesheet" href="https://koukita.github.io/opendata/hodmap/css/leaflet_v1.3.4.css" />
  <script src="https://koukita.github.io/opendata/hodmap/js/leaflet_v1.3.4.js"></script>
  <script src="https://d3js.org/d3.v4.min.js"></script>
  <script type="text/JavaScript" src="https://koukita.github.io/websample/js/encoding.min.js"></script> <!--CSVの文字コード変更-->

  <!-- クラスタリングするプラグイン -->
  <!-- <script src="https://koukita.github.io/opendata/hodmap/js/leaflet.markercluster.js"></script>
  <link rel="stylesheet" href="https://koukita.github.io/opendata/hodmap/css/MarkerCluster.css" />
  <link rel="stylesheet" href="https://koukita.github.io/opendata/hodmap/css/MarkerCluster.Default.css" /> -->
  <!-- 参考にしたサイトURL：https://qiita.com/mitch0807/items/52698a561d4255578657 -->

  <style>
    #mapid { height: 700px; }
  </style>

  北海道Society5.0事例マップ
  <div id="mapid"></div>
	<script>
        //=======================================================
        //２つのCSVをJsonに変換し結合、地図にマーカーとして表示する
        //=======================================================
        //データCSVのURL
        var csv01Url = "data/test_kanko.csv"
        var csv02Url = "data/test_location.csv"

        //CSVを読み込んで、文字コードを変換後Jsonに変換＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝
        var req = new XMLHttpRequest(); // HTTPでファイルを読み込むためのXMLHttpRrequestオブジェクトを生成
        req.open("get", csv01Url, true); // アクセスするファイルを指定
        req.responseType = 'arraybuffer'; //CSVをバイナリデータとして読み込み（重要）
        req.send(null); // HTTPリクエストの発行
        var json01 = [];
        // 非同期CSVのレスポンスが返ってきたら地図作成処理を行う
        //文字コードを変換後にJsonに変換
        req.onload = function(){
            //＝＝１つ目のCSVを文字コードの変換をしてからJsonに変換＝＝＝＝＝＝＝＝＝＝＝＝＝＝
            //CSVファイルの文字コードを変換
            var csv_unicodeStr01 = csv_unicode(req.response) //SJISのテキストデータを渡す
            var tmp = csv_unicodeStr01.split("\n"); // 改行を区切り文字として行を要素とした配列を生成
            // カラム名の取得に使うために配列を作成する
            var csv_column = tmp[0].split(',');
            //UNICODEテキストからJSONを作成
            json01 = csvToJson(csv_unicodeStr01 , { header : 1, columnName : csv_column});
            console.log(json01);
        };    
        console.log(json01);
            
        //＝＝２つ目のCSVを文字コードの変換をしてからJsonに変換＝＝＝＝＝＝＝＝＝＝＝＝＝＝
        var req02 = new XMLHttpRequest(); // HTTPでファイルを読み込むためのXMLHttpRrequestオブジェクトを生成
        req02.open("get", csv02Url, true); // アクセスするファイルを指定
        req02.responseType = 'arraybuffer'; //CSVをバイナリデータとして読み込み（重要）
        req02.send(null); // HTTPリクエストの発行
        req02.onload = function(){

            //CSVファイルの文字コードを変換
            var csv_unicodeStr02 = csv_unicode(req02.response) //SJISのテキストデータを渡す
            var tmp = csv_unicodeStr01.split("\n"); // 改行を区切り文字として行を要素とした配列を生成
            // カラム名の取得に使うために配列を作成する
            var csv_column = tmp[0].split(',');
            //UNICODEテキストからJSONを作成
            var json02 = csvToJson(csv_unicodeStr02 , { header : 1, columnName : csv_column});
            
        };
        console.log("テスト");




        //＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝
        //   CSVの文字コードをUNICODEに変換する関数
        //＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝
        var csv_unicode = function(sjisStr) {
            //UNICODEに文字コード変換したCSVを作成
            if (sjisStr){
                var sjisArray = new Uint8Array(sjisStr)  //文字コードで配列を作成
                var unicodeArray = Encoding.convert(sjisArray,{ //encoding.jsでSJISをUNIDODEに変換
                    to: 'UNICODE',
                    from: 'AUTO'  //文字コードの判定は自動
                });
                var unicodeStr = Encoding.codeToString(unicodeArray); //UNICODEのテキストデータ
                unicodeStr = unicodeStr.replace(/\r/g, '') //Excel特有の改行コード「\r」を削除
            }
            return unicodeStr;
        };


        //＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝
        //   CSVをJsonに変換する関数
        //＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝
        var csvToJson = function(csvStr, userOptions) {
            if (typeof csvStr !== 'string') return null;
            //options
            //header : 除外するヘッダーの行番号（数値）
            //columnName : カラム名（配列）
            //ignoreBlankLine : 空白行の除外（ブーリアン）
            var options = { header : 0, columnName : [], ignoreBlankLine : true };
        
            if (userOptions) {
                if (userOptions.header) options.header = userOptions.header;
                if (userOptions.columnName) options.columnName = userOptions.columnName;
            }
        
            var rows = csvStr.split('\n');
            var json = [], line = [], row = '', data = {};
            var i, len, j, len2;
        
            for (i = 0, len = rows.length; i < len; i++) {
                if ((i + 1) <= options.header) continue;
                if (options.ignoreBlankLine && rows[i] === '') continue;
        
                line = rows[i].split(',');
        
                if (options.columnName.length > 0) {
                    data = {};
                    for (j = 0, len2 = options.columnName.length; j < len2; j++) {
                        if (typeof line[j] !== 'undefined') {
                            row = line[j];
                            row = row.replace(/^"(.+)?"$/, '$1');
                        } else {
                            row = null;
                        }
        
                        data[options.columnName[j]] = row;
                    }
                    json.push(data);
                } else {
                    json.push(line);
                }
            }
        
            return json;
        };
    </script>
</body>
</html>